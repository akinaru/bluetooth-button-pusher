## Firmware Specifications

This wall switch pusher offers following features :
* push function
* LCD panel message
* secure association between Android smartphone & device via LCD panel
* persistent storage on the device to store associated device, security secrets such as key/iv, LCD panel message to be displayed
* all functionnalities except association are password protected

## Security features

This device uses AES 256 bit encyption based on the implementation by Brian Gladman (it used 8-bit byte operation only). The same implementation is used on both side, on Android & on RFduino uc.

Each smartphone Bluetooth controller will associate with the device generating a unique couple xor-key / serial number. This information is sent to the RFduino device and stored in persistent storage. The device will send back its AES key/iv. The whole association is protected by an AES key/iv generated from a random key the user must type on Android smartphone & generated by RFduino device. As a consequence, to associate with Rfduino device, a human must reproduce a visual information via the LCD panel.

All APIs are protected by a one-shot token generated by RFduino device. A GET_TOKEN API is used to retrieve this token from RFduino device. This token is encoded with Smartphone unique xor-key & AES encryption. This assure no replay attack is possible.

The critical APIs are secured by an additionnal password which must be changed when you setup the device for the first time. Default password is "admin". This password is encoded with the smartphone xor-key & encypted with AES.

## API parameters

* abbreviation
 * SN : serial number
 * pwd : password
 * token : random string (can be used only once)
 * AES : encyption with AES key stored on RFduino device
 * AES2 : encyption with AES key generated from user visual code (shared with user via LCD panel)
 * XOR : xor encryption with a xor-key user-specific (generated & exchanged at association)

|  name                 |    code            |       input params             |  output params  | LCD code |
|-----------------------|--------------------|--------------------------------|-----------------|-------------------------|
| GET_TOKEN             |    0x00            |  -                             |   [token]       |  no                     |
| ASSOCIATION_STATUS    |    0x01            |  AES(SN + XOR([token]))        |   [status code] |  no                     |
| PUSH                  |    0x02            |  AES(SN + XOR(pwd + [token]))  |   [status code] |  no                     |
| SET_PASSWORD          |    0x03            |  AES(SN + XOR(pwd + [token]))  |   [status code] |  yes                    | 
| ASSOCIATE             |    0x04            |  -                             |   [status code] |  yes                    | 
| SET_KEYS              |    0x05            |  AES(SN + XOR(pwd + [token]))  |   [status code] |  yes                    | 
| FAILURE               |    0x06            |  -                             |    -            |  no                     | 
| ASSOCIATE_RESPONSE    |    0x07            |  AES2(SN + XOR(pwd + [token]))       |   [status code] |  no                     | 
| RECEIVE_KEYS          |    0x08            |  -                             |   [status code] |  no                     | 
| SET_PASSWORD_RESPONSE |    0x09            |  AES2(SN + XOR(pwd + [token]))       |   [status code] |  no                     | 
| SET_KEYS_RESPONSE     |    0x0A            |  AES2(SN + XOR(pwd + [token]))       |   [status code] |  no                     | 
| DEASSOCIATE           |    0x0B            |  AES(SN + XOR(pwd + [token]))        |   [status code] |  no                     | 
| MESSAGE_TOP           |    0x0C            |  AES(SN + XOR(pwd + [token]))        |   [status code] |  no                     | 
| MESSAGE_BOTTOM        |    0x0D            |  AES(SN + XOR(pwd + [token]))        |   [status code] |  no                     |

## API description

|  name                 |   description                        |
|-----------------------|--------------------------------------|
| GET_TOKEN             |  get a token that can be used only once |
| ASSOCIATION_STATUS    |  ask the device if the SN/XOR key pair sent is already associated |
| PUSH                  |  push wall switch |
| SET_PASSWORD          |  change the password on the RFduino device, this will trigger a user code displayed on LCD |
| ASSOCIATE             |  trigger association for the SN/XOR key pair sent, this will trigger a user code displayed on LCD |
| SET_KEYS              |  change the AES key/iv on the RFduino device, this will trigger a user code displayed on LCD |
| FAILURE               |  send a failure command |
| ASSOCIATE_RESPONSE    |  send the association request encoded with the new AES2 key generated from user code |
| RECEIVE_KEYS          |  request the keys from the RFduino device. This will only return keys if the association was performed just before |
| SET_PASSWORD_RESPONSE |  send the change-password request encoded with the new AES2 key generated from user code |
| SET_KEYS_RESPONSE     |  send the change-keys request encoded with the new AES2 key generated from user code |
| DEASSOCIATE           |  disassociate the SN/Xor key pair (delete from persistent storage as well) |
| MESSAGE_TOP           |  change the top default message of the LCD screen |
| MESSAGE_BOTTOM        |  change the bottom default message of the LCD screen |

## GATT protocol

* the above commands/APIs are sent via GATT characteristic `00002222-0000-1000-8000-00805f9b34fb`
* result is received via GATT characteristic `00002221-0000-1000-8000-00805f9b34fb` via notification

## Large data via GATT protocol

* The limit for GATT characteristic payload is 18 octet. The above commands load more than 18 octet, so payload is divided in bunch of 18 octet sent separatly. The first frame sent to Rfduino device is a frame containing the command code and the length of the payload. When the total payload is received from the device, it is processed directly and the response is returned via notification on characteristic `00002221-0000-1000-8000-00805f9b34fb`.

* The same protocol is used for receiving data from the Rfduino device. Data is split into bunch of 18 octet and sent until everything is received.

## Persistent storage

### Device configuration

Device configuration features a list of `device` structure featuring : 

| prototype          |   description    |
|--------------------|------------------------|
| char device_id[8]  |  device serial |
| char xor_key[32]   |  XOR key |

The maximum associated device number is 25 device (page size is 1024 octet)

### Global configuration

Global configuration features :

| prototype          |   description    |
|--------------------|------------------------|
| char pass[4*16]    |  encrypted password |
| uint16_t flag      |  flag to check against default configuration |
| uint8_t device_num |  device_num for the number of smartphone device associated |
| char key[32]       |  AES key |
| char iv[16]        |  AES iv  |
| char top_message[28] | LCD panel top default message |
| char bottom_message[28] | LCD panel bottom default message |

### Memory page

* smartphone devices configuration is stored on page 250
* global configuration is stored on page 251
